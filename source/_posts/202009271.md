---
title: 微信小程序
date: 2020-09-27 10:01:52
tags: [wechat]
---
### 用[flyio](https://github.com/wendux/fly)重新封装请求
<!-- more -->
```js
// 引入flyio库
const Fly = require("../libs/wx.umd.min");
const fly = new Fly();
fly.config = {
  baseURL: <请求父路径>,
  timeout: <超时时间>,
  headers: {
    "content-type": "application/x-www-form-urlencoded"
  },
  // 自定义参数，重新请求次数
  maxAutoRetries: 3
};

// 拦截器
fly.interceptors.request.use((config) => {
  // 给所有请求添加自定义header
  config.headers["token"] = wx.getStorageSync("token");
  return config;
});

// 响应拦截器
fly.interceptors.response.use(
  (response) => {
    try {
      // 重新获取token
      if (response.data.status === 40331) {
        return refreshToken(response.request);
      }
      app.globalData.isUpdate = true;
      return Promise.resolve(response.data);
    } catch (e) {
      console.log(e.message);
    }
  },
  (err) => {
    if (err.status === 0 || err.status === 1) {
      // 查询请求连接超时，重试
      if (err.request.method === "GET" && err.request.maxAutoRetries > 0) {
        err.request.maxAutoRetries--;
        return fly.request(err.request);
      }
    }
    return Promise.reject(err.response || err);
  }
)

/**
 * 刷新token
 * 
 * @param {*} request 重新请求配置
 */
function refreshToken(request) {
  // 锁定请求
  fly.lock();
  let newFly = new Fly();
  newFly.config = fly.config;
  // 苹果不支持finally
  return newFly.post(<请求路径>).then((d) => {
    wx.setStorageSync("token", d.data.data);
  }).then(() => {
    // 解锁请求
    fly.unlock();
    if (wx.getStorageSync("token")) {
      // 重新请求
      return fly.request(request);
    }
    return Promise.reject();
  }).catch(() => {
    fly.unlock();
  });
}
export default fly;
```