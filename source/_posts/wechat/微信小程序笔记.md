---
title: 微信小程序
date: 2020-09-27 10:01:52
tags: [wechat]
---
### 用[flyio](https://github.com/wendux/fly)重新封装请求
<!-- more -->
```js
// 引入flyio库
const Fly = require("../libs/wx.umd.min");
const fly = new Fly();
fly.config = {
  baseURL: <请求父路径>,
  timeout: <超时时间>,
  headers: {
    "content-type": "application/x-www-form-urlencoded"
  },
  // 自定义参数，重新请求次数
  maxAutoRetries: 3
};

// 拦截器
fly.interceptors.request.use((config) => {
  // 给所有请求添加自定义header
  config.headers["token"] = wx.getStorageSync("token");
  return config;
});

// 响应拦截器
fly.interceptors.response.use(
  (response) => {
    try {
      // 重新获取token
      if (response.data.status === 40331) {
        return refreshToken(response.request);
      }
      app.globalData.isUpdate = true;
      return Promise.resolve(response.data);
    } catch (e) {
      console.log(e.message);
    }
  },
  (err) => {
    if (err.status === 0 || err.status === 1) {
      // 查询请求连接超时，重试
      if (err.request.method === "GET" && err.request.maxAutoRetries > 0) {
        err.request.maxAutoRetries--;
        return fly.request(err.request);
      }
    }
    return Promise.reject(err.response || err);
  }
)

/**
 * 刷新token
 * 
 * @param {*} request 重新请求配置
 */
function refreshToken(request) {
  // 锁定请求
  fly.lock();
  let newFly = new Fly();
  newFly.config = fly.config;
  // 苹果不支持finally
  return newFly.post(<请求路径>).then((d) => {
    wx.setStorageSync("token", d.data.data);
  }).then(() => {
    // 解锁请求
    fly.unlock();
    if (wx.getStorageSync("token")) {
      // 重新请求
      return fly.request(request);
    }
    return Promise.reject();
  }).catch(() => {
    fly.unlock();
  });
}
export default fly;
```

### 自动化测试miniprogram-automator + jest

#### 一、安装运行环境

运行环境
- 安装 Node.js 并且版本大于 8.0
- 基础库版本为 2.7.3 及以上
- 开发者工具版本为 1.02.1907232 及以上

使用小程序自动化 SDK，直接执行以下命令：
```js
npm i miniprogram-automator --save-dev
```

#### 二、微信开发者工具端口开启

1. 任意打开一个小程序进入到微信开发者工具->设置->安全->选择开启服务端口->重新打开开发者工具

2. 开启连接微信开发者工具服务端口对应的自动化端口

在微信开发工具的安装目录下打开命令行工具输入
```js
./cli.bat --auto '小程序目录地址' --auto-port 9420
```

#### 三、编写测试脚本

创建测试脚本`script.test.js`
```js
const automator = require('miniprogram-automator')

automator.launch({
  wsEndpoint: 'ws://localhost:9420'
}).then(async miniProgram => {
  const page = await miniProgram.reLaunch('/page/component/index')
  await page.waitFor(500)
  const element = await page.$('.kind-list-item-hd')
  console.log(await element.attribute('class'))
  await element.tap()

  await miniProgram.close()
})
```

[微信官方文档](https://developers.weixin.qq.com/miniprogram/dev/devtools/auto/quick-start.html)

>注意<br>
>获取页面组件可以用 `await currentPage.$$('组件名')`

最后执行 node path/to/script.test.js 即可看到输出结果。

#### 四、jest

1. 安装jest
```js
npm i jest -g // 全局安装
npm i jest --save-dev // 只在当前项目下安装
```

> 注意<br>
> 安装`jest@26.6.3`版本，`node`版本需>= `10.14.2`, 否则会出编译问题<br>
```js
} catch {
        ^
SyntaxError: Unexpected token {
    at createScript (vm.js:80:10)
    at Object.runInThisContext (vm.js:139:10)
    at Module._compile (module.js:616:28)
    at Object.Module._extensions..js (module.js:663:10)
    at Module.load (module.js:565:32)
    at tryModuleLoad (module.js:505:12)
    at Function.Module._load (module.js:497:3)
    at Module.require (module.js:596:17)
    at require (internal/module.js:11:18)
    at Object.<anonymous> (D:\nodejs\node_global\node_modules\jest\node_modules\jest-cli\bin\jest.js:16:3)
```

2. 初始化jest

```js
jest init
```

3. 编写测试脚本

```js
const automator = require('miniprogram-automator');

describe('自动化测试', () => {
  let miniProgram;

  // 连接本地测试接口
  beforeAll(async () => {
    miniProgram = await automator.connect({
      wsEndpoint: 'ws://localhost:9420',
    });
  });

  // 运行结束后关闭连接
  afterAll(async () => {
    miniProgram.disconnect();
  });

  it('登录, 选择第一个学生', async () => {
    const currentPage = await miniProgram.reLaunch('/pages/login/index')
    await currentPage.waitFor(1000)
    const list = await currentPage.$$('select-student')
    if (list.length > 0) {
      const current = await list[0].$$('.left');
      await current[0].tap();
      await currentPage.waitFor(1000);
    }
  }, 50000);
});
```

4. 运行

```js
jest 脚本路径
```



